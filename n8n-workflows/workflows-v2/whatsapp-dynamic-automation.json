{
  "name": "WhatsApp Kupon Dynamic Automation",
  "versionId": "dynamic-automation-v2-fixed",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 400],
      "webhookId": "whatsapp-dynamic"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\n// Verification check (GET request)\nif (input.query && input.query['hub.mode'] === 'subscribe' && input.query['hub.challenge']) {\n  return [{ json: { route: 'verify', challenge: input.query['hub.challenge'] } }];\n}\n\n// Parse webhook payload\nconst body = input.body || input;\nconst value = body?.entry?.[0]?.changes?.[0]?.value;\n\n// Ignore status updates (delivery receipts)\nif (value?.statuses) {\n  return [{ json: { route: 'ignore', reason: 'status_update' } }];\n}\n\n// Check for messages\nconst messages = value?.messages;\nif (!messages || !messages[0]) {\n  return [{ json: { route: 'ignore', reason: 'no_messages' } }];\n}\n\nconst msg = messages[0];\n\n// Only process text messages\nif (!msg.text || !msg.text.body) {\n  return [{ json: { route: 'ignore', reason: 'not_text' } }];\n}\n\n// Ignore specific phone numbers\nconst ignoredPhones = ['905302500558'];\nif (ignoredPhones.includes(msg.from)) {\n  return [{ json: { route: 'ignore', reason: 'blocked_number' } }];\n}\n\nconst text = msg.text.body.trim();\nconst textLower = text.toLowerCase();\nconst phone = msg.from;\nlet token = null;\nlet route = 'ignore';\n\n// IMPORTANT: Check specific phrases BEFORE regex patterns!\n// Check claim commands first (before kupon regex catches 'kupon kullan')\nif (textLower === 'kupon kullan' || textLower === 'kullan' || textLower === 'claim' || textLower === 'redeem') {\n  route = 'claim';\n} else if (textLower === 'durum' || textLower === 'bakiye' || textLower === 'balance') {\n  route = 'balance';\n} else if (textLower === 'iptal' || textLower === 'dur' || textLower === 'stop') {\n  route = 'optout';\n} else if (textLower === 'yardim' || textLower === 'yardÄ±m' || textLower === 'help' || textLower === '?') {\n  route = 'help';\n} else {\n  // Now check for coupon token pattern (kupon <code>)\n  const kuponMatch = text.match(/^kupon\\s+([A-Za-z0-9]+)$/i);\n  if (kuponMatch) {\n    route = 'coupon';\n    token = kuponMatch[1].toUpperCase();\n  }\n}\n\nreturn [{ json: { route, phone, token, text } }];"
      },
      "id": "parse",
      "name": "Parse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 400]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:3001/api/integrations/services/whatsapp/status",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "Authorization", "value": "Bearer dwsQf8q0BpFWXPqMhwy2SGLG/wHIw1hKyjW8eI4Cgd8=" }] },
        "options": { "response": { "response": { "neverError": true } }, "timeout": 3000 }
      },
      "id": "check-service-status",
      "name": "Check Service Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [650, 400]
    },
    {
      "parameters": {
        "jsCode": "const statusResponse = $input.first().json;\nconst parseData = $('Parse').first().json;\n\n// Check if service is enabled\nconst isEnabled = statusResponse.enabled === true;\n\nif (!isEnabled) {\n  // Service is disabled - return maintenance message\n  return [{ \n    json: { \n      route: 'maintenance',\n      phone: parseData.phone,\n      message: 'ðŸ”§ Sistem bakÄ±mda. LÃ¼tfen daha sonra tekrar deneyin.'\n    } \n  }];\n}\n\n// Service is enabled - continue with normal routing\nreturn [{ \n  json: { \n    ...parseData,\n    serviceEnabled: true\n  } \n}];"
      },
      "id": "check-enabled",
      "name": "Check Enabled",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            { "conditions": { "options": { "caseSensitive": true, "leftValue": "" }, "conditions": [{ "id": "1", "leftValue": "={{ $json.route }}", "rightValue": "verify", "operator": { "type": "string", "operation": "equals" } }], "combinator": "and" }, "renameOutput": true, "outputKey": "verify" },
            { "conditions": { "options": { "caseSensitive": true, "leftValue": "" }, "conditions": [{ "id": "m", "leftValue": "={{ $json.route }}", "rightValue": "maintenance", "operator": { "type": "string", "operation": "equals" } }], "combinator": "and" }, "renameOutput": true, "outputKey": "maintenance" },
            { "conditions": { "options": { "caseSensitive": true, "leftValue": "" }, "conditions": [{ "id": "2", "leftValue": "={{ $json.route }}", "rightValue": "coupon", "operator": { "type": "string", "operation": "equals" } }], "combinator": "and" }, "renameOutput": true, "outputKey": "coupon" },
            { "conditions": { "options": { "caseSensitive": true, "leftValue": "" }, "conditions": [{ "id": "3", "leftValue": "={{ $json.route }}", "rightValue": "balance", "operator": { "type": "string", "operation": "equals" } }], "combinator": "and" }, "renameOutput": true, "outputKey": "balance" },
            { "conditions": { "options": { "caseSensitive": true, "leftValue": "" }, "conditions": [{ "id": "4", "leftValue": "={{ $json.route }}", "rightValue": "claim", "operator": { "type": "string", "operation": "equals" } }], "combinator": "and" }, "renameOutput": true, "outputKey": "claim" },
            { "conditions": { "options": { "caseSensitive": true, "leftValue": "" }, "conditions": [{ "id": "5", "leftValue": "={{ $json.route }}", "rightValue": "help", "operator": { "type": "string", "operation": "equals" } }], "combinator": "and" }, "renameOutput": true, "outputKey": "help" },
            { "conditions": { "options": { "caseSensitive": true, "leftValue": "" }, "conditions": [{ "id": "6", "leftValue": "={{ $json.route }}", "rightValue": "optout", "operator": { "type": "string", "operation": "equals" } }], "combinator": "and" }, "renameOutput": true, "outputKey": "optout" }
          ]
        },
        "options": { "fallbackOutput": "extra" }
      },
      "id": "router",
      "name": "Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [1050, 400]
    },
    {
      "parameters": { "respondWith": "text", "responseBody": "={{ $json.challenge }}" },
      "id": "resp-verify",
      "name": "Respond Verify",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1300, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3001/api/integrations/coupons/consume",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "Authorization", "value": "Bearer dwsQf8q0BpFWXPqMhwy2SGLG/wHIw1hKyjW8eI4Cgd8=" }] },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"phone\":\"{{ $json.phone }}\",\"token\":\"{{ $json.token }}\"}",
        "options": { "response": { "response": { "neverError": true } } }
      },
      "id": "api-coupon",
      "name": "API Coupon",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1300, 250]
    },
    {
      "parameters": {
        "jsCode": "const r = $input.first().json;\nconst p = $('Check Enabled').first().json.phone;\nconst originalText = $('Check Enabled').first().json.text;\nlet msg;\nlet intent = 'coupon_submit';\nlet sentiment = 'neutral';\n\nif (r.error) {\n  // Turkish error messages based on error code\n  const code = r.error.code;\n  if (code === 'INVALID_TOKEN') {\n    msg = 'âŒ Bu kupon kodu gecersiz. Lutfen kodu kontrol edin.';\n    sentiment = 'negative';\n  } else if (code === 'ALREADY_USED') {\n    msg = 'âŒ Bu kupon daha once kullanilmis.';\n    sentiment = 'negative';\n  } else if (code === 'EXPIRED_TOKEN') {\n    msg = 'âŒ Bu kuponun suresi dolmus.';\n    sentiment = 'negative';\n  } else {\n    msg = 'âŒ Bir hata olustu. Lutfen tekrar deneyin.';\n    sentiment = 'negative';\n  }\n} else {\n  msg = `âœ… Kupon eklendi! Bakiye: ${r.balance || 0}/4`;\n  sentiment = 'positive';\n}\n\nreturn [{ json: { phone: p, message: msg, intent, sentiment, inboundText: originalText } }];"
      },
      "id": "fmt-coupon",
      "name": "Fmt Coupon",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 250]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://localhost:3001/api/integrations/coupons/wallet/{{ encodeURIComponent($json.phone) }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "Authorization", "value": "Bearer dwsQf8q0BpFWXPqMhwy2SGLG/wHIw1hKyjW8eI4Cgd8=" }] },
        "options": { "response": { "response": { "neverError": true } } }
      },
      "id": "api-balance",
      "name": "API Balance",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1300, 350]
    },
    {
      "parameters": {
        "jsCode": "const r=$input.first().json;\nconst p=$('Check Enabled').first().json.phone;\nconst originalText = $('Check Enabled').first().json.text;\nlet msg=r.error?'ðŸ“Š HenÃ¼z kuponunuz yok.':`ðŸ“Š Bakiye: ${r.couponCount||0}/4`;\nreturn [{json:{phone:p,message:msg,intent:'balance_check',sentiment:'neutral',inboundText:originalText}}];"
      },
      "id": "fmt-balance",
      "name": "Fmt Balance",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 350]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3001/api/integrations/coupons/claim",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "Authorization", "value": "Bearer dwsQf8q0BpFWXPqMhwy2SGLG/wHIw1hKyjW8eI4Cgd8=" }] },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"phone\":\"{{ $json.phone }}\"}",
        "options": { "response": { "response": { "neverError": true } } }
      },
      "id": "api-claim",
      "name": "API Claim",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1300, 450]
    },
    {
      "parameters": {
        "jsCode": "const r = $input.first().json;\nconst p = $('Check Enabled').first().json.phone;\nconst originalText = $('Check Enabled').first().json.text;\nconst err = r.error;\nlet msg;\nlet sentiment = 'neutral';\n\nif (err) {\n  const bal = err.balance || 0;\n  const needed = err.needed || (4 - bal);\n  const threshold = err.threshold || 4;\n  msg = `âŒ Yeterli kupon yok. Mevcut: ${bal}/${threshold}. ${needed} kupon daha gerekiyor.`;\n  sentiment = 'negative';\n} else if (r.ok && r.redemptionId) {\n  if (r.isNew === false) {\n    // Existing pending - remind user\n    msg = `â³ Zaten bekleyen bir kullanim talebiniz var!\\nðŸŽ« Kod: ${r.redemptionId}\\nResepsiyona bu kodu gosterin. Onaylandiktan sonra yeni kupon toplayabilirsiniz.`;\n    sentiment = 'neutral';\n  } else {\n    msg = `ðŸŽ‰ Tebrikler! Ucretsiz masaj hakkiniz onaylandi!\\nðŸŽ« Kod: ${r.redemptionId}\\nResepsiyona bu kodu gosterin.`;\n    sentiment = 'positive';\n  }\n} else {\n  msg = 'âŒ Bir hata olustu. Lutfen tekrar deneyin.';\n  sentiment = 'negative';\n}\n\nreturn [{ json: { phone: p, message: msg, intent: 'redemption', sentiment, inboundText: originalText } }];"
      },
      "id": "fmt-claim",
      "name": "Fmt Claim",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 450]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:3001/api/integrations/knowledge/context",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "Authorization", "value": "Bearer dwsQf8q0BpFWXPqMhwy2SGLG/wHIw1hKyjW8eI4Cgd8=" }] },
        "options": { "response": { "response": { "neverError": true } }, "timeout": 3000 }
      },
      "id": "fetch-knowledge",
      "name": "Fetch Knowledge",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1300, 550]
    },
    {
      "parameters": {
        "jsCode": "const p=$('Check Enabled').first().json.phone;\nconst originalText = $('Check Enabled').first().json.text;\nconst knowledge=$input.first().json;\n\n// Build help message from knowledge base\nlet msg = 'ðŸŽ« Kupon Sistemi YardÄ±m\\n\\n';\n\n// Add services info if available\nif (knowledge.services) {\n  const services = Object.values(knowledge.services);\n  if (services.length > 0) {\n    msg += 'ðŸ“Œ Hizmetler:\\n';\n    services.slice(0, 3).forEach(s => msg += `â€¢ ${s}\\n`);\n    msg += '\\n';\n  }\n}\n\n// Add hours if available\nif (knowledge.hours) {\n  msg += 'ðŸ• Ã‡alÄ±ÅŸma Saatleri:\\n';\n  Object.values(knowledge.hours).forEach(h => msg += `â€¢ ${h}\\n`);\n  msg += '\\n';\n}\n\n// Add commands\nmsg += 'ðŸ“± Komutlar:\\n';\nmsg += 'â€¢ DURUM - Bakiye sorgula\\n';\nmsg += 'â€¢ KUPON <KOD> - Kupon ekle\\n';\nmsg += 'â€¢ KUPON KULLAN - Hediye al\\n';\nmsg += 'â€¢ IPTAL - Bildirimleri kapat';\n\n// Add contact if available\nif (knowledge.contact && knowledge.contact.phone) {\n  msg += `\\n\\nðŸ“ž Ä°letiÅŸim: ${knowledge.contact.phone}`;\n}\n\nreturn [{json:{phone:p,message:msg,intent:'help',sentiment:'neutral',inboundText:originalText}}];"
      },
      "id": "fmt-help",
      "name": "Fmt Help",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 550]
    },
    {
      "parameters": {
        "jsCode": "const p=$('Check Enabled').first().json.phone;\nconst originalText = $('Check Enabled').first().json.text;\nreturn [{json:{phone:p,message:'âœ… Bildirimler kapatÄ±ldÄ±.',intent:'optout',sentiment:'neutral',inboundText:originalText}}];"
      },
      "id": "fmt-optout",
      "name": "Fmt OptOut",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 650]
    },
    {
      "parameters": {
        "jsCode": "const p=$('Check Enabled').first().json.phone;\nconst originalText = $('Check Enabled').first().json.text;\nconst msg=$('Check Enabled').first().json.message;\nreturn [{json:{phone:p,message:msg,intent:'maintenance',sentiment:'neutral',inboundText:originalText}}];"
      },
      "id": "fmt-maintenance",
      "name": "Fmt Maintenance",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 200]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst phone = data.phone;\nconst inboundText = data.inboundText;\nconst outboundMessage = data.message;\nconst intent = data.intent;\nconst sentiment = data.sentiment;\n\n// Return both inbound and outbound logs, plus the message data for Send WA\nreturn [\n  // Log inbound message\n  { json: { phone, direction: 'inbound', messageText: inboundText, intent, sentiment: 'neutral', logType: 'inbound' } },\n  // Log outbound message\n  { json: { phone, direction: 'outbound', messageText: outboundMessage, intent, sentiment, logType: 'outbound' } },\n  // Pass message data to Send WA\n  { json: { phone, message: outboundMessage, forSending: true } }\n];"
      },
      "id": "prepare-logs",
      "name": "Prepare Logs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1700, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "" },
          "conditions": [{ "id": "filter-log", "leftValue": "={{ $json.logType }}", "rightValue": "", "operator": { "type": "string", "operation": "notEmpty" } }],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-for-log",
      "name": "Filter For Log",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [1900, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3001/api/integrations/whatsapp/interaction",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "Authorization", "value": "Bearer dwsQf8q0BpFWXPqMhwy2SGLG/wHIw1hKyjW8eI4Cgd8=" }] },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"phone\":\"{{ $json.phone }}\",\"direction\":\"{{ $json.direction }}\",\"messageText\":\"{{ $json.messageText }}\",\"intent\":\"{{ $json.intent }}\",\"sentiment\":\"{{ $json.sentiment }}\"}",
        "options": { "response": { "response": { "neverError": true } }, "timeout": 2000 }
      },
      "id": "log-interaction",
      "name": "Log Interaction",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [2100, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "" },
          "conditions": [{ "id": "filter-send", "leftValue": "={{ $json.forSending }}", "rightValue": "true", "operator": { "type": "boolean", "operation": "true" } }],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-for-send",
      "name": "Filter For Send",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [1900, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/471153662739049/messages",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": { "parameters": [{ "name": "Authorization", "value": "Bearer EAASoZBpRZBYVgBQI9tq7dTqVxCtB5SIHUKYZBcnsdGxpcU5xmmivOno8AUvQhsFLD0TiBEX71aCYP6NldygAA36fzuZCKK7ZApU7LBGXQiUTR0SLEnZC4AxZAvc6UD7qtkQMXGhZAEzrS6fFvooEu7As0AuqUBBDkJpRomKU3lJ4fQ5l8LCbg2clZAN0vegcX185tegZDZD" }] },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"messaging_product\":\"whatsapp\",\"to\":\"{{ $json.phone }}\",\"text\":{\"body\":\"{{ $json.message }}\"}}",
        "options": {}
      },
      "id": "send-wa",
      "name": "Send WA",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [2100, 500]
    },
    {
      "parameters": { "respondWith": "text", "responseBody": "OK" },
      "id": "resp-ok",
      "name": "OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2100, 400]
    },
    {
      "parameters": { "respondWith": "text", "responseBody": "OK" },
      "id": "resp-ignore",
      "name": "Ignore",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1300, 750]
    }
  ],
  "connections": {
    "Webhook": { "main": [[{ "node": "Parse", "type": "main", "index": 0 }]] },
    "Parse": { "main": [[{ "node": "Check Service Status", "type": "main", "index": 0 }]] },
    "Check Service Status": { "main": [[{ "node": "Check Enabled", "type": "main", "index": 0 }]] },
    "Check Enabled": { "main": [[{ "node": "Router", "type": "main", "index": 0 }]] },
    "Router": { "main": [
      [{ "node": "Respond Verify", "type": "main", "index": 0 }],
      [{ "node": "Fmt Maintenance", "type": "main", "index": 0 }],
      [{ "node": "API Coupon", "type": "main", "index": 0 }],
      [{ "node": "API Balance", "type": "main", "index": 0 }],
      [{ "node": "API Claim", "type": "main", "index": 0 }],
      [{ "node": "Fetch Knowledge", "type": "main", "index": 0 }],
      [{ "node": "Fmt OptOut", "type": "main", "index": 0 }],
      [{ "node": "Ignore", "type": "main", "index": 0 }]
    ]},
    "API Coupon": { "main": [[{ "node": "Fmt Coupon", "type": "main", "index": 0 }]] },
    "Fmt Coupon": { "main": [[{ "node": "Prepare Logs", "type": "main", "index": 0 }]] },
    "API Balance": { "main": [[{ "node": "Fmt Balance", "type": "main", "index": 0 }]] },
    "Fmt Balance": { "main": [[{ "node": "Prepare Logs", "type": "main", "index": 0 }]] },
    "API Claim": { "main": [[{ "node": "Fmt Claim", "type": "main", "index": 0 }]] },
    "Fmt Claim": { "main": [[{ "node": "Prepare Logs", "type": "main", "index": 0 }]] },
    "Fetch Knowledge": { "main": [[{ "node": "Fmt Help", "type": "main", "index": 0 }]] },
    "Fmt Help": { "main": [[{ "node": "Prepare Logs", "type": "main", "index": 0 }]] },
    "Fmt OptOut": { "main": [[{ "node": "Prepare Logs", "type": "main", "index": 0 }]] },
    "Fmt Maintenance": { "main": [[{ "node": "Prepare Logs", "type": "main", "index": 0 }]] },
    "Prepare Logs": { "main": [
      [
        { "node": "Filter For Log", "type": "main", "index": 0 },
        { "node": "Filter For Send", "type": "main", "index": 0 }
      ]
    ]},
    "Filter For Log": { "main": [[{ "node": "Log Interaction", "type": "main", "index": 0 }]] },
    "Log Interaction": { "main": [[{ "node": "OK", "type": "main", "index": 0 }]] },
    "Filter For Send": { "main": [[{ "node": "Send WA", "type": "main", "index": 0 }]] },
    "Send WA": { "main": [[{ "node": "OK", "type": "main", "index": 0 }]] }
  },
  "active": true,
  "settings": { "executionOrder": "v1" }
}
